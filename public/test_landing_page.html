<!doctype html>

<head>
<script>
// https://stackoverflow.com/questions/17309199/how-to-send-variables-from-one-file-to-another-in-javascript

// https://stackoverflow.com/questions/5411538/redirect-from-an-html-page

function extractURLdata(){

   // Extract workerId
    var name = 'workerId'
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regexS = "[\\?&]" + name + "=([^&#]*)";
    var regex = new RegExp(regexS);
    var results = regex.exec(window.location.href) || ["", "workerId_notFound"] 
    workerId = results[1];

    // Extract assignmentId
    name = 'assignmentId'
  name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
  var regexS = "[\\?&]" + name + "=([^&#]*)";
  var regex = new RegExp(regexS);
  console.log(results)
  var results = regex.exec(window.location.href) || ["", ""] 
  assignmentId = results[1];

  // Extract hitId
  name = 'hitId'
  name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
  var regexS = "[\\?&]" + name + "=([^&#]*)";
  var regex = new RegExp(regexS);
  console.log(results)
  var results = regex.exec(window.location.href) || ["", "hitId_not_found"] 
  hitId = results[1];


    var SUBJECT = {
    "SubjectID":'MechanicalTurker_'+workerId,
    "Species": "human",
    "assignmentId": assignmentId,
    'workerId': workerId,
    'hitId':hitId
    }
    return SUBJECT
}

async function saveData() {
  console.log('hello')
   // Store url to experiment file .txt
   
   var EXPERIMENT = {
  "Experiment":[{
            "Task":"SR",
            "StageNickname":"mil_toy_test_stage0",
            "PunishTimeOut": 1000,
            "ChoiceTimeOut": 5000,
            "t_SampleON": 100,
            "t_SampleOFF": 0,
            "NGridPoints":3, 
            "SampleGridIndex":4, 
            "ObjectGridMapping": [2,8],
            "initial_TaskStream_trial_number": 0,
            "samplingRNGseed": 0,
            "AverageReturnCriterion":0,
            "MinTrialsCriterion":5, 
            "probability_repeat_trial_if_wrong":1,
             "SampleImageBagNames": [
              "ToyASample",
              "ToyBSample"
             ],
             "TestImageBagNames": [
              "ToyAtoken",
              "ToyBtoken"
             ]
            }, 
            {
            "Task":"SR", 
            "StageNickname":"mil_toy_test_stage1",
            "PunishTimeOut": 1000,
            "ChoiceTimeOut": 5000,
            "t_SampleON": 100,
            "t_SampleOFF": 0,
            "NGridPoints":3, 
            "SampleGridIndex":4, 
            "ObjectGridMapping": [8,2],
            "initial_TaskStream_trial_number": 0,
            "samplingRNGseed": 0,
            "AverageReturnCriterion":0,
            "MinTrialsCriterion":5,
            "probability_repeat_trial_if_wrong":1,
             "SampleImageBagNames": [
              "ToyASample",
              "ToyBSample"
             ],
             "TestImageBagNames": [
              "ToyAtoken",
              "ToyBtoken"
             ]
            }], 
  "ImageBags":{"ToyASample":["https://s3.amazonaws.com/monkeyturk/Resources/ImageBags/A.png"], 
              "ToyBSample":["https://s3.amazonaws.com/monkeyturk/Resources/ImageBags/B.png"], 
              "ToyAtoken":["https://s3.amazonaws.com/monkeyturk/Resources/ImageBags/Atoken.png"], 
              "ToyBtoken":["https://s3.amazonaws.com/monkeyturk/Resources/ImageBags/Btoken.png"]}
}


   data = btoa(JSON.stringify(EXPERIMENT));
   localStorage.setItem('Experiment_string', data);

   // Store mechanical turk settings
   mechanical_turk_data = btoa('{"MinimumTrialsForCashIn": 10, "MAX_SESSION_TRIALS_MECHANICALTURK": 100}', data);
   localStorage.setItem('HIT_settings_string', mechanical_turk_data)

   console.log(window.location.href)

   // Store information sent by Amazon via the current url 
   SUBJECT = extractURLdata()
    console.log('Landing screen SUBJECT', SUBJECT)
    localStorage.setItem('SubjectSettings_string', btoa(JSON.stringify(SUBJECT)))
}


(async function(){
  await saveData()
})()

window.location.href = "mkturk.html"//"https://s3.amazonaws.com/monkeyturksandbox/public/mkturk.html" // 'https://s3.amazonaws.com/monkeyturksandbox/public/mkturk.html'

</script>
</head>

<body>
Loading HIT...
</body>
</html>