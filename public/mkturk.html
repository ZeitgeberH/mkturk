<!doctype html>
<style>
#myProgress {
  width: 90%;
  margin-left: 1%;
  margin-right: 8%;
  background-color: #ddd;
  z-index:101;
  position: absolute;
}

#myBar {
  width: 0.2%;
  height: 15px;
  background-color: #4CAF50;
  color:white;
  font-size: 8px; 
  font-family: 'Helvetica Neue';
  z-index:101;
  position: absolute;
}
</style>

<head>
<meta name="mobile-web-app-capable" content="yes"> <!-- full screen https://developer.chrome.com/multidevice/android/installtohomescreen -->
<meta name="viewport" content="width=device-width, user-scalable=no"> <!-- do not allow window rescaling.  To avoid window rescaling in portrait mode, added with=device-width from http://stackoverflow.com/questions/22771523/ipad-w-retina-safari-reported-dimensions-in-landscape-make-no-sense. Also, removes 300-350ms tap delay (https://developers.google.com/web/updates/2013/12/300ms-tap-delay-gone-away) -->

<link rel="manifest" href="mkturkmanifest.json">
<link rel="icon" href="mkturklogo48.png">

<script src="mkturk_installsettings.js"></script>
<script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>

</head>

<!-- ************* BODY *************** -->
<body bgcolor=#7F7F7F>
<div id="canvasdiv" style="position:relative; width:100vw; height:100vh">
	<button name="connectble" style="visibility:hidden; position: absolute; top: 45%; left: 45%; height: 50px; width: 200px; border-radius: 20px">Connect to Bluetooth juicer</button>

	<button name="noble" style="visibility:hidden; position: absolute; top: 55%; left: 45%; height: 50px; width: 200px; border-radius: 20px">No Bluetooth juicer</button>

	<div id="myProgress">
  		<div id="myBar"></div>
	</div>






	<button name="doneEditingParams" style="visibility:hidden; position: absolute; top: 45%; left: 70%; height: 75px; width: 100px; border-radius: 20px">Done editing params</button>

	<button name="doneTestingTask" style="visibility:hidden; position: absolute; top: 55%; left: 70%; height: 75px; width: 200px; border-radius: 20px; z-index:101">Done with testing trials</button>

	<button name="SyncButton" style="visibility:hidden; position: absolute; top: 1%; left: 92%; height: 30px; width: 50px; font-size: 10px; color: green; border-radius: 10px; z-index:101">Sync data</button>


	<canvas id="canvasblank" width="0" height="0" src="" style="z-index:99; position: absolute; left: 0px; top: 0px;"> </canvas>
	<canvas id="canvassample" width="0" height="0" src="" style="z-index:1; position: absolute; left: 0px; top: 0px;"> </canvas>
	<canvas id="canvastest" width="0" height="0" src="" style="z-index:2; position: absolute; left: 0px; top: 0px;"> </canvas>
	<canvas id="canvastouchfix" width="0" height="0" src="" style="z-index:3; position: absolute; left: 0px; top: 0px;"> </canvas>
	<canvas id="canvaseyefix" width="0" height="0" src="" style="z-index:4; position: absolute; left: 0px; top: 0px;"> </canvas>
	<canvas id="canvasreward" width="0" height="0" src="" style="z-index:5; position: absolute; left: 0px; top: 0px;"> </canvas>
	<canvas id="canvasphotoreward" width="0" height="0" src="" style="z-index:6; position: absolute; left: 0px; top: 0px;"> </canvas>
	<canvas id="canvaspunish" width="0" height="0" src="" style="z-index:7; position: absolute; left: 0px; top: 0px;"> </canvas>
</div>
<dialog id="subjectID_dialog">
  <p>Select subject: </p>
   <!--Pull down menu that will hold file list-->
  <select id="subjectID_list">
  	<option value="-1">--</option>
  </select>
</dialog>

<script src="seedrandom.js" type="text/javascript"></script>
<script src="mkturk_globalvariables.js"></script>
<script src="mkturk_eventlisteners.js" type="text/javascript"></script>
<script src="mkturk_dropbox.js" type="text/javascript"></script>
<script src="mkturk_ImageBuffer.js" type="text/javascript"></script>
<script src="mkturk_TrialQueue.js" type="text/javascript"></script>
<script src="mkturk_screenfunctions.js"></script>
<script src="mkturk_automator.js" type="text/javascript"></script>
<script src="mkturk_bluetooth.js" type="text/javascript"></script>
<script src="mkturk_utils.js" type="text/javascript"></script>
<script src="mkturk_runtrial.js" type="text/javascript"></script>
<script src="mkturk_hardware.js" type="text/javascript"></script>
<script src="mkturk_Screen.js" type="text/javascript"></script>

<script>

//================== AUTHENTICATE ==================//
var DBX_REDIRECT_URI = DBX_REDIRECT_URI_ROOT + "mkturk.html"
if (isAuthenticated()){
	//Create an instance of Dropbox with the access token
	var dbx = new Dropbox({accessToken: getAccessTokenFromUrl()})
}
else {
	var dbx = new Dropbox({clientId: DBX_CLIENT_ID});
	var dbx_authUrl = dbx.getAuthenticationUrl(DBX_REDIRECT_URI);
	window.location.href = dbx_authUrl //send to Dropbox sign-in screen
}

DW = new DropboxWriter(dbx)
setupDragTracker()
setupTapTracker()
//setupMouseTracker()



// GET PARAMFILE NAME
var subjectdialog = document.getElementById("subjectID_dialog");
var subjectlistobj = document.getElementById("subjectID_list");
for (var i=subjectlist.length-1; i>=0; i--){
	var opt = document.createElement('option');
	opt.value = i;
	opt.innerHTML = subjectlist[i];
	subjectlistobj.appendChild(opt);
}
subjectlistobj.addEventListener("change",subjectlist_listener,false);

// Button callbacks
document.querySelector("button[name=connectble]").addEventListener(
	'touchend',findBLEDevice,false)
document.querySelector("button[name=connectble]").addEventListener(
	'mouseup',findBLEDevice,false)
document.querySelector("button[name=noble]").addEventListener(
	'touchend',skipBLEDevice,false)
document.querySelector("button[name=noble]").addEventListener(
	'mouseup',skipBLEDevice,false)
document.querySelector("button[name=doneEditingParams]").addEventListener(
	'touchend',doneEditingParams_listener,false)
document.querySelector("button[name=doneEditingParams]").addEventListener(
	'mouseup',doneEditingParams_listener,false)
document.querySelector("button[name=doneTestingTask]").addEventListener(
	'touchend',doneTestingTask_listener,false)
document.querySelector("button[name=doneTestingTask]").addEventListener(
	'mouseup',doneTestingTask_listener,false)

document.querySelector("button[name=SyncButton]").addEventListener(
	'mouseup',sync_data_listener,false)
document.querySelector("button[name=SyncButton]").addEventListener(
	'touchend',sync_data_listener,false)



//============= Initialize Audio & Battery Objects ==================//
	// Prevent window scrolling and bounce back effect
	//document.body.addEventListener('touchmove',function(event){
	//	event.preventDefault();
	//}, {capture: false, passive:false});
	
	DEVICE.DevicePixelRatio = window.devicePixelRatio || 1;
	var visiblecanvasobj = CANVAS.obj[CANVAS.front];
	var visiblecontext = visiblecanvasobj.getContext("2d");
	var backingStoreRatio = visiblecontext.webkitBackingStorePixelRatio ||
	                            visiblecontext.mozBackingStorePixelRatio ||
	                            visiblecontext.msBackingStorePixelRatio ||
	                            visiblecontext.oBackingStorePixelRatio ||
	                            visiblecontext.backingStorePixelRatio || 1;
	DEVICE.CanvasRatio = backingStoreRatio/DEVICE.DevicePixelRatio
	
	//Monitor Battery - from: http://www.w3.org/TR/battery-status/
	navigator.getBattery().then(function(batteryobj){
		DEVICE.BatteryLDT.push([batteryobj.level, batteryobj.dischargingTime, Math.round(performance.now())]);
		batteryobj.addEventListener('levelchange',function(){
			DEVICE.BatteryLDT.push([batteryobj.level, batteryobj.dischargingTime, Math.round(performance.now())]);
		})
	});



(async function(){

	//================== await create SoundPlayer ==================// 
	SP = new SoundPlayer()
	await SP.build()
	
	// display sync button 
	document.querySelector("button[name=SyncButton]").style.visibility = "visible"

	//================== AWAIT CONNECT TO BLE ==================//
	document.querySelector("button[name=connectble]").style.display = "block"
	document.querySelector("button[name=connectble]").style.visibility = "visible"
	document.querySelector("button[name=noble]").style.display = "block"
	document.querySelector("button[name=noble]").style.visibility = "visible"
	await connectBLEButtonPromise()

	document.querySelector("button[name=connectble]").style.display = "none" //if do style.visibility=hidden, element will still occupy space
	document.querySelector("button[name=noble]").style.display = "none"
	
	//================== AWAIT LOAD SUBJECT PARAMS ==================//
	subjectdialog.showModal()
	await subjectIDPromise()
	ParamFilePath = PARAM_DIRPATH + SESSION.Subject + "_params.txt";
	_funcreturn = await DW.loadParametersfromDropbox(ParamFilePath)
	TASK = _funcreturn[0]
	ParamFileRev = _funcreturn[1]
	
	
	
	//========= Start in TEST mode =======//
	document.querySelector("button[name=doneTestingTask]").style.display = "block"
	document.querySelector("button[name=doneTestingTask]").style.visibility = "visible"
	

	TRIAL_NUMBER_FROM_SESSION_START = 0
	FLAGS.need2loadImages = 1
	FLAGS.debug_mode = 1 // starts in debug mode; press 'Done Testing' button to start actual trials and store in appropriate directory

// ============ MAIN LOOP ==================================================================================== // 
console.log('LINE 206', TASK)
__initial_load_TASK = TASK
__initial_load_TASK_ARCHIVE = TASK_ARCHIVE // Reset to this once you transition from debug to test mode

if (TASK.Automator == 1){
	AM = new Automator("uniform_with_replacement")
	await AM.build(5)
}

INITIALIZE = true

// Start in testing mode
while(FLAGS.debug_mode == 1){
	await runtrial()
}
toggleProgressbar(1)

transition_from_debug_to_science_trials()
toggleProgressbar(0)

// Science mode
while(true){
	await runtrial()
}

} ())

</script>
</body>
</html>