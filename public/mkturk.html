<!doctype html>
<style>


#AutomatorLoadBar {
  margin:;
  width: 0.2%;
  height: 15px;
  background-color: #4CAF50;
  color:white;
  font-size: 8px; 
  font-family: 'Helvetica Neue';
  z-index:101;
  position: absolute;
  overflow:hidden;
}

#ImageLoadBar {
  margin-top: 17px;
  width: 0.2%;
  height: 15px;
  background-color: #4CAF50;
  opacity: 0.5;
  color:white;
  font-size: 8px; 
  font-family: 'Helvetica Neue';
  z-index:101;
  position: absolute;
  overflow:hidden;
}


#StageBar {
  margin-top: 34px;
  width: 0.2%;
  height: 15px;
  background-color: #aed3f4;
  color:white;
  font-size: 8px; 
  font-family: 'Helvetica Neue';
  z-index:101;
  position: absolute;
  overflow:hidden;
}

#TrialCounter {
   position: fixed;
   margin-top: -5px;
   left: 1px; /* space between top of browser and annoying box */
   height: 30px;
   color:white;
   font-size: 8px; 
   z-index:102;
   font-family: 'Helvetica Neue';
   color:white;
}

#DebugMessageTextBox {
   position: fixed;
   margin-top: 51px;
   left: 1px; /* space between top of browser and annoying box */
   height: 30px;
   color:white;
   font-size: 8px; 
   z-index:102;
   font-family: 'Helvetica Neue';
   color:white;

}

#SessionTextBox {
   position: fixed;
   margin-top: 15px;
   left: 40%; /* space between top of browser and annoying box */
   height: 34px;
   width:20%;
   color:white;
   font-size:14px; 
   z-index:102;
   font-family: 'Helvetica Neue';
   vertical-align:middle;
   color:#4B4B4B;
   background-color:#E4E4E4;
   border-radius:3px;

}
</style>

<head>
<meta name="mobile-web-app-capable" content="yes"> <!-- full screen https://developer.chrome.com/multidevice/android/installtohomescreen -->
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <!-- do not allow window rescaling.  To avoid window rescaling in portrait mode, added with=device-width from http://stackoverflow.com/questions/22771523/ipad-w-retina-safari-reported-dimensions-in-landscape-make-no-sense. Also, removes 300-350ms tap delay (https://developers.google.com/web/updates/2013/12/300ms-tap-delay-gone-away) -->

<link rel="manifest" href="mkturkmanifest.json">
<link rel="icon" href="mkturklogo48.png">

<script src="mkturk_installsettings.js"></script>
<script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>

</head>

<!-- ************* BODY *************** -->
<body style="overflow-y: hidden;background-color:#7F7F7F">

<div id="myProgress", style="overflow:hidden">
		<div id="AutomatorLoadBar"></div>
		<div id="ImageLoadBar"></div>
		<div id="StageBar"></div>
</div>

<button name="connectble" style="z-index:101; visibility:hidden; position: absolute; top: 45%; left: 45%; height: 50px; width: 200px; border-radius: 20px">Connect to Bluetooth juicer</button>

<button name="noble" style="z-index:101; visibility:hidden; position: absolute; top: 55%; left: 45%; height: 50px; width: 200px; border-radius: 20px">No Bluetooth juicer</button>


<div id="TrialCounter">0</div>
<div id="DebugMessageTextBox">0</div>
<div id="SessionTextBox"><b>Subject:</b> <br><b>Experiment:</b></div>


<button name="doneTestingTask" style="visibility:hidden; position: absolute; top: 55%; left: 70%; height: 75px; width: 200px; border-radius: 20px; z-index:101">Done with testing trials</button>

<button name="SyncButton" style="visibility:hidden; position: absolute; margin-top:4px; left: 97%; font-size: 6px; color: #A6A6A6; padding:10px 10px; border:0px solid #959595; z-index:101; background-color: #E6E6E6; text-align:center; opacity: 1">Save</button>

<button onclick="reloadPage()" name="ReloadButton" style="visibility:visible; position: absolute; margin-top:4px; left: 93%; font-size: 6px; color: #000000; padding:10px 10px; border-radius:5px solid #000000; z-index:101; background-color: #66ccff; text-align:center;">Reload</button>


<canvas id="blank" width="0" height="0" src="" style="z-index:99; position: absolute; left: 0px; top: 0px;width:100%; height:100%; padding:0px; margin:0px;"> </canvas>
<canvas id="sample" width="0" height="0" src="" style="z-index:1; position: absolute; left: 0px; top: 0px;width:100%; height:100%; padding:0px; margin:0px;"> </canvas>
<canvas id="test" width="0" height="0" src="" style="z-index:2; position: absolute; left: 0px; top: 0px;width:100%; height:100%; padding:0px; margin:0px;"> </canvas>
<canvas id="touchfix" width="0" height="0" src="" style="z-index:3; position: absolute; left: 0px; top: 0px;width:100%; height:100%; padding:0px; margin:0px;"> </canvas>
<canvas id="eyefix" width="0" height="0" src="" style="z-index:4; position: absolute; left: 0px; top: 0px;width:100%; height:100%; padding:0px; margin:0px;"> </canvas>
<canvas id="reward" width="0" height="0" src="" style="z-index:5; position: absolute; left: 0px; top: 0px;width:100%; height:100%; padding:0px; margin:0px;"> </canvas>
<canvas id="photoreward" width="0" height="0" src="" style="z-index:6; position: absolute; left: 0px; top: 0px;width:100%; height:100%; padding:0px; margin:0px;"> </canvas>
<canvas id="punish" width="0" height="0" src="" style="z-index:7; position: absolute; left: 0px; top: 0px;width:100%; height:100%; padding:0px; margin:0px;"> </canvas>


<dialog id="subjectID_dialog">
  <p>Select subject: </p>
   <!--Pull down menu that will hold file list-->
  <select id="subjectID_list">
  	<option value="-1">--</option>
  </select>
</dialog>

<dialog id="ExperimentFile_dialog">
  <p>Select experiment: </p>
   <!--Pull down menu that will hold file list-->
  <select id="ExperimentFile_list">
  	<option value="-1">--</option>
  </select>
</dialog>

<script src="seedrandom.js" type="text/javascript"></script>
<script src="mkturk_Screen.js" type="text/javascript"></script>
<script src="mkturk_globalvariables.js"></script>
<script src="mkturk_eventlisteners.js" type="text/javascript"></script>
<script src="mkturk_ImageBuffer.js" type="text/javascript"></script>
<script src="mkturk_TrialQueue.js" type="text/javascript"></script>
<script src="mkturk_screenfunctions.js"></script>
<script src="mkturk_bluetooth.js" type="text/javascript"></script>
<script src="mkturk_utils.js" type="text/javascript"></script>
<script src="mkturk_runtrial.js" type="text/javascript"></script>
<script src="mkturk_hardware.js" type="text/javascript"></script>
<script src="disk_template.js" type="text/javascript"></script>
<script src="data_writer.js" type="text/javascript"></script>
<script src="TaskStreamer.js" type="text/javascript"></script>
<script src="mkturk_UX.js" type="text/javascript"></script>
<script src="Amazon_utils.js" type="text/javascript"></script>
<script src="TabletTask_utils.js" type="text/javascript"></script>



<script>


wdm("Initialized webpage")

SIO = new S3_IO()
DIO = new DropboxIO()

DWr = new DataWriter(DIO)
UX = new UX_poller(DIO)

setupDragTracker() // Writes to TOUCHSTRING and TOUCHSTRING_UPDATECOUNTER
setupTapTracker() // Writes to TOUCHSTRING and TOUCHSTRING_UPDATECOUNTER

initializeSetupButtons()

//============= Initialize Audio & Battery Objects ==================//	
DEVICE.DevicePixelRatio = window.devicePixelRatio || 1;
var visiblecanvasobj = CANVAS.obj[CANVAS.front];
var visiblecontext = visiblecanvasobj.getContext("2d");
var backingStoreRatio = visiblecontext.webkitBackingStorePixelRatio ||
                            visiblecontext.mozBackingStorePixelRatio ||
                            visiblecontext.msBackingStorePixelRatio ||
                            visiblecontext.oBackingStorePixelRatio ||
                            visiblecontext.backingStorePixelRatio || 1;
DEVICE.CanvasRatio = backingStoreRatio/DEVICE.DevicePixelRatio

//Monitor Battery - from: http://www.w3.org/TR/battery-status/
navigator.getBattery().then(function(batteryobj){
	DEVICE.BatteryLDT.push([batteryobj.level, batteryobj.dischargingTime, Math.round(performance.now())]);
	batteryobj.addEventListener('levelchange',function(){
		DEVICE.BatteryLDT.push([batteryobj.level, batteryobj.dischargingTime, Math.round(performance.now())]);
	})
});


(async function(){


await setupTabletTask()

// ============ MAIN LOOP ==================================================================================== // 
document.querySelector("button[name=SyncButton]").style.visibility = "visible"

FixationRewardMap = new RewardMap()
ChoiceRewardMap = new RewardMap()
SD = new ScreenDisplayer()

console.log('initialized hellothere')

INITIALIZE = true


windowHeight = window.innerHeight
|| document.documentElement.clientHeight
|| document.body.clientHeight;


windowWidth = window.innerWidth
|| document.documentElement.clientWidth
|| document.body.clientWidth;



    //============= SET UP CANVAS =============//
    // Update canvas based on latest TASK state: 
    refreshCanvasSettings(TS.EXPERIMENT[TS.state.current_stage_index]); 
    
    for (var i = 0; i <= CANVAS.names.length-1; i++) {
        setupCanvas(CANVAS.obj[CANVAS.names[i]]);
    }
    if (DEVICE.DevicePixelRatio !== 1){
        scaleCanvasforHiDPI(CANVAS.obj.sample);
        scaleCanvasforHiDPI(CANVAS.obj.test);
    }

    CANVAS.workspace = [
        0,
        0,
        CANVAS.obj["touchfix"].width,
        CANVAS.obj["touchfix"].height
    ]


    // Write down dimensions of (assumedly) all images in samplebag and testbag, based on the first sample image.
    var representative_trial = await TS.get_trial()
    console.log('representative_trial', representative_trial)

    var representative_image = representative_trial['sample_image']
    DEVICE.source_ImageWidthPixels = representative_image.width
    DEVICE.source_ImageHeightPixels = representative_image.height

    CANVAS.FixationRadius=(DEVICE.source_ImageWidthPixels/2)*SubjectSettings['FixationScale']*DEVICE.CanvasRatio

console.log(DEVICE)
funcreturn = defineImageGrid(TS.EXPERIMENT[0]['NGridPoints'], 
    DEVICE.source_ImageWidthPixels, 
    DEVICE.source_ImageHeightPixels, 
   	SubjectSettings['GridScale']);

xcanvascenter = funcreturn[0]
ycanvascenter = funcreturn[1]

DEVICE.XGridCenter = funcreturn[2]
DEVICE.YGridCenter = funcreturn[3]

console.log('windowWidth', windowWidth, 'windowHeight', windowHeight)
// Reference: https://www.w3schools.com/js/js_window.asp


// Start in testing mode
wdm("Running debug mode...")
while(FLAGS.debug_mode == 1){
	await runtrial()
  UX.poll()
}

transition_from_debug_to_science_trials()

// Science mode
while(true){
	await runtrial()
  UX.poll()
}



} ())

</script>
</body>
</html>